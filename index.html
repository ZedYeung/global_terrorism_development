<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <style>
    circle {
      fill: red;
      stroke: black;
      stroke-width: 0;
      opacity: 0.4;
    }

    .mask {
      fill: black;
      opacity: 0.6;
    }

    h2 {
      text-align: center;
      color: black;
    }

    div.years_buttons {
      position: fixed;
      top: 5px;
      left: 5px;
      width: 200px;
      height: 100%;
      display: flex;
      flex-flow: column wrap;
    }

    div.years_buttons div {
      background-color: black;
      color: red;
      width: 40px;
      height: 25px;
      padding: 3px;
      margin: 3px;
      border-radius: 5px;
    }

    div.toolTip {
      position: absolute;
      /*display: none;*/
      min-width: 200px;
      max-width: 700px;
      height: auto;
      background: black;
      border: 1px;
      border-radius: 8px;
      border-color: red;
      color: red;
      padding: 5px;
      text-align: center;
      visibility: hidden;
      z-index: 10;
    }
  </style>
  <script type="text/javascript">
    function draw(geo_data) {
      "use strict";
      var margin = 50,
        width = 1400 - margin,
        height = 600 - margin;

      d3.select("body")
        .append("h2")
        .text("Grobal Terrorism ");

      var svg = d3.select("body")
        .append("svg")
        .attr("width", width + margin)
        .attr("height", height + margin)
        .append('g')
        .attr('class', 'map');

      var projection = d3.geo.mercator()
        .scale(200)
        .translate([width / 2, height / 1.5]);

      var path = d3.geo.path().projection(projection);

      var map = svg.selectAll('path')
        .data(geo_data.features)
        .enter()
        .append('path')
        .attr('d', path)
        .style('fill', 'black')
        .style('stroke', 'black')
        .style('stroke-width', 0.5);

      var years = [];

      for (var i = 1970; i <= 2018; i += 1) {
        if (i !== 1993) {
          years.push(i);
        }
      };

      function plot_points(data) {

        var intensity_max = d3.max(data, function(d) {
          return d["intensity"];
        });

        var radius = d3.scale.sqrt()
          .domain([0, intensity_max])
          .range([0, 30]);

        var tooltip = d3.select("body")
          .append("div")
          .attr("class", "toolTip");

        svg.append('g')
          .attr('class', 'bubble');

        function update(year) {
          var filtered = data.filter(function(d) {
            if (year == 2017) {
              return d.year == 2016;
            } else if (year == 2018) {
              return d
            } else {
              return d.year == year;
            }
          });

          if (year == 2017 | year == 2018) {
            d3.select("h2")
              .text("Grobal Terrorism before 2017");
          } else {
            d3.select("h2")
              .text("Grobal Terrorism " + year);
          }

          if (year == 2018) {
            d3.select('rect').remove();
            d3.selectAll('text').remove();
          }

          if (year == 2017) {
            var format = d3.format(",d");

            svg.append('rect')
              .attr("class", "mask")
              .attr("x", 0)
              .attr("y", 0)
              .attr("width", 1400)
              .attr("height", 600);

            svg.append("text")
              .attr("x", 100)
              .attr("y", 100)
              .text("What Terrorist Done these years?")
              .style('fill', 'red')
              .style('font-size', "70px");

            svg.append("text")
              .attr("x", 200)
              .attr("y", 200)
              .text("In 205 countries, Terrorists")
              .style('fill', 'red')
              .style('font-size', "60px");

            svg.append("text")
              .transition()
              .duration(500)
              .attr("x", 300)
              .attr("y", 300)
              .text("Kill")
              .style('fill', 'red')
              .style('font-size', "60px");


            svg.append("text")
              .attr('id', 'fatalities')
              .attr("x", 700)
              .attr("y", 300)
              .style('fill', 'red')
              .style('font-size', "60px");

            d3.select('#fatalities')
              .transition()
              .duration(500)
              .tween("#fatalities", function() {
                var i = d3.interpolateRound(0, 383554);
                return function(t) {
                  this.textContent = i(t);
                };
              });

            svg.append("text")
              .transition()
              .duration(500)
              .attr("x", 300)
              .attr("y", 400)
              .text("Wound")
              .style('fill', 'red')
              .style('font-size', "60px");

            svg.append("text")
              .attr('id', 'injuries')
              .attr("x", 700)
              .attr("y", 400)
              .style('fill', 'red')
              .style('font-size', "60px");

            d3.select('#injuries')
              .transition()
              .duration(500)
              .tween("text", function() {
                var i = d3.interpolateRound('0', '496117');
                return function(t) {
                  this.textContent = i(t);
                };
              });

            svg.append("text")
              .attr("x", 100)
              .attr("y", 500)
              .text("For some reason, some casualties cannot be gathered")
              .style('fill', 'red')
              .style('font-size', "30px");
          };

          var countries = d3.set();

          filtered.forEach(function(d) {
            countries.add(d['country']);
          });

          function update_countries(d) {
            if (countries.values().indexOf(d.properties.name) !== -1) {
              return "black";
            } else {
              return 'white';
            }
          };

          svg.selectAll('path')
            .transition()
            .duration(500)
            .style('fill', update_countries)
            .style('stroke', update_countries);

          var circles = svg.select('g')
            .selectAll('circle')
            .data(filtered, function(d) {
              return d.id;
            });

          circles.enter()
            .append("circle")
            .transition()
            .duration(500)
            .attr('cx', function(d) {
              return d["coords"][0];
            })
            .attr('cy', function(d) {
              return d["coords"][1];
            })
            .attr('r', function(d) {
              return radius(d["intensity"]);
            });

          circles.exit().remove();

          circles.on("mouseover", function(d) {
              tooltip.style("visibility", "visible")
                .style("left", d3.event.pageX + 10 + "px")
                .style("top", d3.event.pageY - 25 + "px")
                .html("<span style='color:red'>" + d["summary"] + "</span><br>" +
                  "<strong>Attack type:</strong> <span style='color:red'>" + d["attacktype"] + "</span><br>" +
                  "<strong>Target:</strong> <span style='color:red'>" + d["target"] + "</span><br>" +
                  "<strong>Fatalities:</strong> <span style='color:red'>" + d["fatalities"] + "  " + "</span>" +
                  "<strong>Injuries:</strong> <span style='color:red'>" + d["injuries"] + "</span>")
            })
            .on("mouseout", function() {
              tooltip.style("visibility", "hidden");
            });
        };

        var year_idx = 0;

        var year_interval = setInterval(function() {
          update(years[year_idx]);

          year_idx++;

          if (year_idx >= years.length) {
            clearInterval(year_interval);

            var buttons = d3.select("body")
              .append("div")
              .attr("class", "years_buttons")
              .selectAll("div")
              .data(years.slice(0, -2))
              .enter()
              .append("div")
              .text(function(d) {
                return d;
              });

            buttons.on("click", function(d) {
              d3.select(".years_buttons")
                .selectAll("div")
                .transition()
                .duration(200)
                .style("color", "red")
                .style("background", "black");

              d3.select(this)
                .transition()
                .duration(200)
                .style("background", "red")
                .style("color", "black");
              update(d);
            });
          }
        }, 1000);
      };

      d3.csv("./data/global_terrorism_map.csv", function(d) {
        d['longitude'] = +d['longitude'];
        d['latitude'] = +d['latitude'];
        d['coords'] = projection([d['longitude'], d['latitude']]);
        d["fatalities"] = +d["fatalities"];
        d["injuries"] = +d["injuries"];
        d['intensity'] = 1 + d["fatalities"] + d["injuries"] * 0.5;
        return d;
      }, plot_points);
    };
  </script>
</head>

<body>
  <script type="text/javascript">
    d3.json("./data/countries.geo.json", draw);
  </script>
</body>

</html>
